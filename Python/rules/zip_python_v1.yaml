rules:
  - id: unsafe_unpacking
    languages:
      - python
    severity: ERROR
    message: Unsafe Zip Unpacking 
    patterns:
      - pattern-either: 
          #- pattern: $FD.extractall(...)
          - pattern: shutil.unpack_archive(...)
          - pattern: shutil.copyfileobj($SOURCE, $DESTINATION)
          - pattern: shutil.copy($SOURCE, $DESTINATION)

      - pattern-not: shutil.unpack_archive(..., format='zip', ...)

      - pattern-either: 
          #- pattern-inside: |
          #    import shutil
          #    ...
          - pattern-inside: |
              import tarfile
              ...
              with tarfile.open($FILE) as $FD:
                ...
          - pattern-inside: |-
              import tarfile
              ...
              with tarfile.open($FILE, ...) as $FD:
              ...
              with $FD.extractfile(...) as $SOURCE:
                ...
          - pattern-inside: |
              import zipfile
              ...
              with zipfile.ZipFile($FILE, 'r') as $FD:
                ...
                for $FILENAME in $FD.namelist():
                  ...
                  with $FD.open($FILENAME) as $SOURCE:
                    ...
          - pattern-inside: |
              import zipfile
              ...
              with zipfile.ZipFile($FILE, 'r') as $FD:
                ...
                for $FILENAME in $FD.namelist():
                  ...
                  with open($FILENAME, ...) as $DESTINATION:
                    ...


                    
          - pattern-inside: |
              import zipfile
              ...
              $FD = zipfile.ZipFile($FILE, 'r')
              ...
              for $FILENAME in $FD.namelist():
                ...
                with $FD.open($FILENAME) as $SOURCE:
                  ...
          - pattern-inside: |
              import zipfile
              ...
              $FD = zipfile.ZipFile($FILE, 'r')
              ...
              for $FILENAME in $FD.namelist():
                ...
                with open($FILENAME, ...) as $DESTINATION:
                  ...
          - pattern-inside: |
              import zipfile
              ...
              with zipfile.ZipFile($FILE, 'r') as $FD:
                ...
                for $FILENAME in $FD.namelist():
                  ...
                  $SOURCE = $FD.open($FILENAME)
                  ...
          - pattern-inside: |
              import zipfile
              ...
              with zipfile.ZipFile($FILE, 'r') as $FD:
                ...
                for $FILENAME in $FD.namelist():
                  ...
                  $DESTINATION = open($FILENAME, ...)
                  ...
          - pattern-inside: |
              import zipfile
              ...
              $FD = zipfile.ZipFile($FILE, 'r')
                ...
              for $FILENAME in $FD.namelist():
                ...
                $SOURCE = $FD.open($FILENAME)
                ...
          - pattern-inside: |
              import zipfile
              ...
              $FD = zipfile.ZipFile($FILE, 'r')
              ...
              for $FILENAME in $FD.namelist():
                ...
                $DESTINATION = open($FILENAME, ...)
                ...
          - pattern-inside: |
              import zipfile
              ...
              $FD = zipfile.ZipFile($FILE, ...)
              ...
              with $FD.namelist() as $FILENAME:
                ...
                for $SOURCE in $FILENAME:
                  ...
