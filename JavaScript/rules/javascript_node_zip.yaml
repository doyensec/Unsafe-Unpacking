rules:
  - id: unsafe_unpacking
    languages:
      - javascript
    severity: ERROR
    message: Unsafe Zip Unpacking 
    patterns:
        - patterns: 
            - pattern-either: 
                - pattern-inside: |
                    $NODEZIP = require('node-zip')
                    ...
                - pattern-inside: |
                    import $NODEZIP from 'node-zip'
                    ...
            - pattern-either:
                - pattern-inside: |
                    $ZIP = $NODEZIP($DATA)
                    ...
                - pattern-inside: |
                    $ZIP = new $NODEZIP($DATA, ...)
                    ...
                - pattern-inside: |
                    $ZIP = new $NODEZIP($DATA)
                    ...

        - patterns:
            - pattern-either:
                - pattern-inside: |
                    $FILES = $ZIP.files
                    ...
                    for ($FILE in $FILES) { ... }
                - pattern-inside: |
                    for ($FILE in $ZIP.files) { ... }
                - pattern-inside: |
                    $FILES = $ZIP.files
                    ...
                    Object.keys($FILES).forEach(($FILE) => { ... })
                - pattern-inside: |
                    Object.keys($ZIP.files).forEach(($FILE) => { ... })
      
            - pattern-either:
                - patterns:
                    - pattern: $FS.writeFileSync(<... $FILE ...>, ...)

                - patterns:
                    - pattern: $FS.writeFileSync($PATH, ...)
                    - pattern-not-inside: |
                        $PATH = path.join(..., path.basename($FILE))
                        ...
                    - pattern-either:
                        - pattern-inside: |
                            $PATH = path.join(..., $FILE)
                            ...
                        - pattern-inside: |
                            $PATH = <... $FILE ...>
                            ...